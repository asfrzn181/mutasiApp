<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Mutasi Jabatan</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        body { background-color: #f4f6f9; font-size: 0.9rem; }
        .login-container { max-width: 400px; margin: 80px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-badge { padding: 5px 12px; border-radius: 50px; font-weight: bold; font-size: 0.75rem; }
        .bg-terisi { background-color: #d1e7dd; color: #0f5132; }
        .bg-kosong { background-color: #f8d7da; color: #842029; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .select2-container .select2-selection--single { height: 38px !important; display: flex; align-items: center; border-color: #dee2e6; }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered { padding-left: 10px; }
        /* Flatpickr fix */
        .flatpickr-input { background-color: white !important; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="!isLoggedIn" class="login-container text-center">
        <h3 class="text-primary mb-3"><i class="fas fa-cube"></i> E-MUTASI</h3>
        <form @submit.prevent="handleLogin">
            <div class="form-floating mb-3">
                <input v-model="auth.url" type="text" class="form-control" placeholder="URL" required>
                <label>URL Web App</label>
            </div>
            <div class="form-floating mb-3">
                <input v-model="auth.token" type="password" class="form-control" placeholder="Token" required>
                <label>Token API</label>
            </div>
            <button :disabled="isLoading" class="btn btn-primary w-100 py-2">
                <span v-if="isLoading" class="spinner-border spinner-border-sm"></span>
                <span v-else>MASUK APLIKASI</span>
            </button>
        </form>
    </div>

    <div v-else>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm mb-4">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#"><i class="fas fa-cube"></i> E-MUTASI</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="nav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item" v-for="menu in menus" :key="menu.id">
                            <a class="nav-link" :class="{active: currentView === menu.id}" href="#" @click.prevent="currentView = menu.id">
                                <i :class="menu.icon"></i> {{ menu.label }}
                            </a>
                        </li>
                    </ul>
                    <button class="btn btn-danger btn-sm" @click="logout"><i class="fas fa-power-off"></i> Keluar</button>
                </div>
            </div>
        </nav>

        <div class="container pb-5">
            <transition name="fade" mode="out-in">
                
                <div v-if="currentView === 'dashboard'" key="dash">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-success text-white">
                                <div class="card-body"><h2>{{ stats.terisi }}</h2><small>Jabatan Terisi</small></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-danger text-white">
                                <div class="card-body"><h2>{{ stats.kosong }}</h2><small>Jabatan Kosong</small></div>
                            </div>
                        </div>
                    </div>
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold">Peta Jabatan</div>
                        <div class="card-body">
                            <data-table :headers="['Jabatan', 'Eselon', 'Status', 'Pemegang']" :items="dashboardData">
                                <template #row="{ item }">
                                    <td>{{ item.nama_jabatan }}</td>
                                    <td>{{ item.eselon }}</td>
                                    <td>
                                        <span :class="['status-badge', item.status === 'TERISI' ? 'bg-terisi' : 'bg-kosong']">
                                            {{ item.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div v-if="item.status === 'TERISI'">
                                            <b>{{ item.pemegang.nama }}</b><br><small class="text-muted">{{ item.pemegang.nip }}</small>
                                        </div>
                                        <span v-else class="text-muted">-</span>
                                    </td>
                                </template>
                            </data-table>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'mutasi'" key="mutasi">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-primary text-white fw-bold">INPUT MUTASI</div>
                                <div class="card-body">
                                    <form @submit.prevent="submitMutasi">
                                        <div class="mb-3">
                                            <label class="fw-bold small">Pegawai</label>
                                            <select2 v-model="mutasiForm.nip" :options="pejabatOptions" placeholder="Cari Pegawai..."></select2>
                                        </div>

                                        <div class="mb-3">
                                            <label class="fw-bold small text-danger">Jenis Mutasi</label>
                                            <select v-model="mutasiForm.jenis_mutasi" class="form-select">
                                                <option value="Promosi">Promosi</option>
                                                <option value="Rotasi">Rotasi</option>
                                                <option value="Demosi">Demosi / Non-Job</option>
                                                <option value="Mutasi Masuk">Mutasi Masuk</option>
                                            </select>
                                            <div v-if="isDemosi" class="small text-danger mt-1">
                                                <i class="fas fa-exclamation-triangle"></i> Jabatan lama ditutup, status menjadi Non-Job.
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="fw-bold small">Jabatan Tujuan <span class="badge bg-success ms-1">Hanya Kosong</span></label>
                                            <select2 v-model="mutasiForm.id_formasi" :options="formasiOptions" :disabled="isDemosi" placeholder="Cari Jabatan Kosong..."></select2>
                                            <div v-if="!isDemosi" class="form-text small">Hanya menampilkan formasi yang statusnya <b>KOSONG</b>.</div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="small">TMT (Tgl Mulai)</label>
                                                <input type="date" v-model="mutasiForm.tgl_mulai" class="form-control" required>
                                            </div>
                                            <div class="col-6">
                                                <label class="small">No SK</label>
                                                <input type="text" v-model="mutasiForm.no_sk" class="form-control" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="small">Tanggal SK</label>
                                            <input type="date" v-model="mutasiForm.tgl_sk" class="form-control" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="small fw-bold text-success">Keterangan</label>
                                            <textarea v-model="mutasiForm.keterangan" class="form-control" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="small fw-bold text-primary">Link Dokumen</label>
                                            <input v-model="mutasiForm.dokumen_pendukung" type="url" class="form-control" placeholder="https://...">
                                        </div>

                                        <button class="btn btn-success w-100 fw-bold">PROSES MUTASI</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header bg-white fw-bold">Cek Riwayat Jabatan</div>
                                <div class="card-body">
                                    
                                    <div class="mb-3">
                                        <label class="small fw-bold mb-1">Cari Pegawai:</label>
                                        <select2 v-model="searchNip" :options="pejabatOptions" placeholder="Ketik Nama / NIP..."></select2>
                                    </div>
                                    <button class="btn btn-secondary w-100 mb-3" @click="cariRiwayat">
                                        <i class="fas fa-search"></i> Tampilkan Riwayat
                                    </button>
                                    
                                    <div v-if="riwayatList.length > 0">
                                        <ul class="list-group list-group-flush">
                                            <li v-for="h in riwayatList" class="list-group-item px-0">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <div class="fw-bold text-primary">{{ getJabatanName(h.jabatan_id) }}</div>
                                                        <div class="small text-muted">{{ getUnitKerja(h.jabatan_id) }}</div>
                                                        <div class="small">SK: {{ h.no_sk }} | {{ h.ket || '-' }}</div>
                                                    </div>
                                                    <span :class="['badge', h.status === 'AKTIF' ? 'bg-success' : 'bg-secondary']">{{ h.status }}</span>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    <div v-else-if="searched" class="alert alert-warning py-2 small">Tidak ada riwayat ditemukan untuk pegawai ini.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'pejabat'" key="pejabat">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center"><span>Data Pejabat</span><button class="btn btn-primary btn-sm" @click="openModalPejabat()"><i class="fas fa-plus"></i> Tambah</button></div>
                        <div class="card-body">
                            <data-table :headers="['NIP', 'Nama', 'Pangkat', 'Aksi']" :items="pejabatData">
                                <template #row="{ item }">
                                    <td>{{ item.nip }}</td><td>{{ item.nama }}</td><td>{{ item.pangkat }}</td>
                                    <td><button class="btn btn-warning btn-sm me-1" @click="openModalPejabat(item)"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" @click="hapusData('hapus_pejabat', {nip: item.nip})"><i class="fas fa-trash"></i></button></td>
                                </template>
                            </data-table>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'formasi'" key="formasi">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center"><span>Master Formasi</span><button class="btn btn-primary btn-sm" @click="openModalFormasi()"><i class="fas fa-plus"></i> Tambah</button></div>
                        <div class="card-body">
                            <data-table :headers="['Jabatan', 'Eselon', 'Unit Kerja', 'Jenis', 'Aksi']" :items="formasiData">
                                <template #row="{ item }">
                                    <td>{{ item.nama_jabatan }}</td><td>{{ item.eselon }}</td><td>{{ item.unit_kerja || '-' }}</td><td><span class="badge bg-info text-dark">{{ item.jenis_jabatan }}</span></td>
                                    <td><button class="btn btn-warning btn-sm me-1" @click="openModalFormasi(item)"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" @click="hapusData('hapus_formasi', {id: item.id})"><i class="fas fa-trash"></i></button></td>
                                </template>
                            </data-table>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'nonjob'" key="nonjob">
                     <div class="card shadow-sm border-warning">
                        <div class="card-header bg-warning text-dark fw-bold">Laporan Non-Job</div>
                        <div class="card-body">
                            <data-table :headers="['NIP', 'Nama', 'Pangkat', 'Status']" :items="nonJobData">
                                <template #row="{ item }"><td>{{ item.nip }}</td><td>{{ item.nama }}</td><td>{{ item.pangkat }}</td><td><span class="badge bg-warning text-dark">Non-Job</span></td></template>
                            </data-table>
                        </div>
                    </div>
                </div>

            </transition>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    // --- COMPONENT: SELECT2 ---
    const Select2 = {
        props: ['modelValue', 'options', 'disabled', 'placeholder'],
        template: `<select class="form-select" :disabled="disabled"></select>`,
        mounted() {
            const vm = this;
            $(this.$el).select2({ theme: 'bootstrap-5', width: '100%', placeholder: this.placeholder, data: this.options })
                .val(this.modelValue).trigger('change')
                .on('change', function () { vm.$emit('update:modelValue', $(this).val()); });
        },
        watch: {
            modelValue(val) { $(this.$el).val(val).trigger('change'); },
            options(opts) { $(this.$el).empty().select2({ theme: 'bootstrap-5', width: '100%', placeholder: this.placeholder, data: opts }).val(this.modelValue).trigger('change'); },
            disabled(val) { $(this.$el).prop('disabled', val); }
        }
    };

    // --- COMPONENT: DATA TABLE ---
    const DataTable = {
        props: ['headers', 'items'],
        data() { return { search: '', pageSize: 10, currentPage: 1 }; },
        computed: {
            filteredItems() {
                if(!this.search) return this.items;
                const lower = this.search.toLowerCase();
                return this.items.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(lower)));
            },
            paginatedItems() { const start = (this.currentPage - 1) * this.pageSize; return this.filteredItems.slice(start, start + this.pageSize); },
            totalPages() { return Math.ceil(this.filteredItems.length / this.pageSize); }
        },
        template: `
            <div>
                <div class="d-flex justify-content-between mb-3"><select v-model="pageSize" class="form-select w-auto"><option :value="5">5</option><option :value="10">10</option><option :value="50">50</option></select><input v-model="search" class="form-control w-auto" placeholder="Cari data..."></div>
                <div class="table-responsive"><table class="table table-hover table-striped"><thead class="table-light"><tr><th v-for="h in headers">{{ h }}</th></tr></thead><tbody><tr v-for="item in paginatedItems" :key="item.id || item.nip"><slot name="row" :item="item"></slot></tr><tr v-if="items.length === 0"><td :colspan="headers.length" class="text-center py-3">Tidak ada data</td></tr></tbody></table></div>
                <div class="d-flex justify-content-between align-items-center mt-2" v-if="totalPages > 1"><small>Hal {{ currentPage }}/{{ totalPages }}</small><div><button class="btn btn-sm btn-outline-secondary me-1" :disabled="currentPage===1" @click="currentPage--">Prev</button><button class="btn btn-sm btn-outline-secondary" :disabled="currentPage===totalPages" @click="currentPage++">Next</button></div></div>
            </div>`
    };

    createApp({
        components: { 'select2': Select2, 'data-table': DataTable },
        data() {
            return {
                isLoggedIn: false, isLoading: false, auth: { url: '', token: '' },
                currentView: 'dashboard',
                menus: [{id: 'dashboard', label: 'Dashboard', icon: 'fas fa-chart-pie'}, {id: 'pejabat', label: 'Data Pejabat', icon: 'fas fa-users'}, {id: 'formasi', label: 'Master Formasi', icon: 'fas fa-sitemap'}, {id: 'mutasi', label: 'Proses Mutasi', icon: 'fas fa-exchange-alt'}, {id: 'nonjob', label: 'Laporan Non-Job', icon: 'fas fa-user-clock'}],
                dashboardData: [], pejabatData: [], formasiData: [], nonJobData: [],
                mutasiForm: { nip: '', id_formasi: '', jenis_mutasi: 'Rotasi', tgl_mulai: '', no_sk: '', tgl_sk: '', keterangan: '', dokumen_pendukung: '' },
                searchNip: '', riwayatList: [], searched: false
            }
        },
        computed: {
            stats() { return { terisi: this.dashboardData.filter(x => x.status === 'TERISI').length, kosong: this.dashboardData.filter(x => x.status === 'KOSONG').length }; },
            isDemosi() { return this.mutasiForm.jenis_mutasi === 'Demosi'; },
            pejabatOptions() { return this.pejabatData.map(p => ({id: p.nip, text: `${p.nama} (${p.nip})`})); },
            
            // --- LOGIKA FILTER FORMASI KOSONG ---
            formasiOptions() { 
                const occupiedIds = this.dashboardData.filter(x => x.status === 'TERISI').map(x => String(x.id_formasi));
                return this.formasiData.filter(f => !occupiedIds.includes(String(f.id))).map(f => ({id: f.id, text: `[KOSONG] ${f.nama_jabatan} - ${f.unit_kerja||''} (${f.eselon})`})); 
            }
        },
        mounted() {
            const sessUrl = sessionStorage.getItem('api_url'); const sessToken = sessionStorage.getItem('api_token');
            if(sessUrl && sessToken) { this.auth.url = sessUrl; this.auth.token = sessToken; this.handleLogin(); }
        },
        watch: { currentView(newVal) { this.loadDataForView(newVal); } },
        methods: {
            async post(action, data = {}) { data.token = this.auth.token; const res = await axios.post(`${this.auth.url}?action=${action}`, JSON.stringify(data)); return res.data; },
            async get(action, params = '') { const res = await axios.get(`${this.auth.url}?action=${action}&token=${this.auth.token}${params}`); return res.data; },
            
            async handleLogin() {
                this.isLoading = true;
                try {
                    const res = await this.get('get_formasi');
                    if(res.status === 'success') { sessionStorage.setItem('api_url', this.auth.url); sessionStorage.setItem('api_token', this.auth.token); this.isLoggedIn = true; this.loadDataForView('dashboard'); } 
                    else throw new Error();
                } catch(e) { Swal.fire('Error', 'Login Gagal', 'error'); } finally { this.isLoading = false; }
            },
            logout() { sessionStorage.clear(); location.reload(); },

            async loadDataForView(view) {
                Swal.showLoading();
                try {
                    if(view === 'dashboard') { const res = await this.get('dashboard_peta'); this.dashboardData = res.data; } 
                    else if(view === 'pejabat') { const res = await this.get('get_pejabat'); this.pejabatData = res.data; }
                    else if(view === 'formasi') { const res = await this.get('get_formasi'); this.formasiData = res.data; }
                    else if(view === 'nonjob') { const res = await this.get('laporan_nonjob'); this.nonJobData = res.data; }
                    else if(view === 'mutasi') {
                        const [r1, r2, r3] = await Promise.all([this.get('get_pejabat'), this.get('get_formasi'), this.get('dashboard_peta')]);
                        this.pejabatData = r1.data;
                        this.formasiData = r2.data;
                        this.dashboardData = r3.data; 
                    }
                    Swal.close();
                } catch(e) { Swal.fire('Error', 'Gagal memuat data', 'error'); }
            },

            // CRUD Actions
            async openModalPejabat(item = null) {
                const isEdit = !!item;
                const { value: form } = await Swal.fire({ title: isEdit ? 'Edit' : 'Tambah', html: `<input id="n" class="swal2-input" placeholder="NIP" value="${item?.nip||''}" ${isEdit?'disabled':''}><input id="nm" class="swal2-input" placeholder="Nama" value="${item?.nama||''}"><input id="p" class="swal2-input" placeholder="Pangkat" value="${item?.pangkat||''}">`, preConfirm: () => ({ nip: document.getElementById('n').value, nama: document.getElementById('nm').value, pangkat: document.getElementById('p').value, nip_lama: item?.nip }) });
                if(form) { if(isEdit) form.nip_baru = form.nip; const res = await this.post(isEdit ? 'edit_pejabat' : 'tambah_pejabat', form); this.checkResponse(res, 'pejabat'); }
            },
            async openModalFormasi(item = null) {
                const isEdit = !!item;
                const { value: form } = await Swal.fire({ title: isEdit ? 'Edit' : 'Tambah', html: `<input id="nm" class="swal2-input" placeholder="Jabatan" value="${item?.nama_jabatan||''}"><input id="es" class="swal2-input" placeholder="Eselon" value="${item?.eselon||''}"><input id="uk" class="swal2-input" placeholder="Unit Kerja" value="${item?.unit_kerja||''}"><select id="jn" class="swal2-input"><option value="Administrator">Administrator</option><option value="Pengawas">Pengawas</option><option value="JPT">JPT</option><option value="Pelaksana">Pelaksana</option><option value="Fungsional">Fungsional</option></select>`, didOpen: () => { if(item) document.getElementById('jn').value = item.jenis_jabatan; }, preConfirm: () => ({ id: item?.id, nama_jabatan: document.getElementById('nm').value, eselon: document.getElementById('es').value, unit_kerja: document.getElementById('uk').value, jenis_jabatan: document.getElementById('jn').value }) });
                if(form) { const res = await this.post(isEdit ? 'edit_formasi' : 'tambah_formasi', form); this.checkResponse(res, 'formasi'); }
            },
            async hapusData(action, payload) { const conf = await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}); if(conf.isConfirmed) { const res = await this.post(action, payload); this.checkResponse(res, this.currentView); } },

            async submitMutasi() {
                if(!this.mutasiForm.nip) return Swal.fire('Error', 'Pilih Pegawai', 'warning');
                if(!this.isDemosi && !this.mutasiForm.id_formasi) return Swal.fire('Error', 'Pilih Jabatan', 'warning');
                const payload = { ...this.mutasiForm };
                if(this.isDemosi) payload.id_formasi = 0;
                Swal.showLoading();
                const res = await this.post('proses_mutasi', payload);
                if(res.status === 'success') { Swal.fire('Sukses', res.message, 'success'); this.mutasiForm = { nip: '', id_formasi: '', jenis_mutasi: 'Rotasi', tgl_mulai: '', no_sk: '', tgl_sk: '', keterangan: '', dokumen_pendukung: '' }; } else Swal.fire('Gagal', res.message, 'error');
            },
            async cariRiwayat() { if(!this.searchNip) return; this.riwayatList = []; const res = await this.get('get_riwayat', `&nip=${this.searchNip}`); this.riwayatList = res.data; this.searched = true; },
            
            getJabatanName(id) { const f = this.formasiData.find(x => String(x.id) === String(id)); return f ? f.nama_jabatan : `ID ${id} (Arsip)`; },
            getUnitKerja(id) { const f = this.formasiData.find(x => String(x.id) === String(id)); return f ? `${f.unit_kerja || '-'} | Eselon: ${f.eselon}` : '-'; },
            checkResponse(res, reloadView) { if(res.status === 'success') { Swal.fire({icon:'success', title:'Berhasil', timer:1000, showConfirmButton:false}); this.loadDataForView(reloadView); } else Swal.fire('Gagal', res.message, 'error'); }
        }
    }).mount('#app');
</script>
</body>
</html>