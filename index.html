<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Mutasi Jabatan</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        body { background-color: #f4f6f9; font-size: 0.85rem; }
        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; }
        .login-container { width: 100%; max-width: 400px; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Custom UI Utilities */
        .status-badge { padding: 4px 10px; border-radius: 50px; font-weight: bold; font-size: 0.7rem; }
        .bg-terisi { background-color: #d1e7dd; color: #0f5132; }
        .bg-kosong { background-color: #f8d7da; color: #842029; }
        .pre-wrap { white-space: pre-wrap; }
        
        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Library Overrides */
        .select2-container .select2-selection--single { height: 38px !important; display: flex; align-items: center; border-color: #dee2e6; }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered { padding-left: 10px; }
        .flatpickr-input { background-color: white !important; }
        .table-laporan th { background-color: #f8f9fa; vertical-align: middle; text-align: center; border-bottom: 2px solid #dee2e6; }
        .table-laporan td { vertical-align: middle; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
            "vue-demi": "https://unpkg.com/vue-demi@0.14.6/lib/index.mjs",
            "pinia": "https://unpkg.com/pinia@2.1.7/dist/pinia.esm-browser.js",
            "@vue/devtools-api": "https://unpkg.com/@vue/devtools-api@6.5.1/lib/esm/index.js",
            "axios": "https://cdn.skypack.dev/axios",
            "sweetalert2": "https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.esm.all.js"
        }
    }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>

<div id="app">
    <div v-if="!isLoggedIn" class="login-wrapper">
        <div class="login-container text-center">
            <h3 class="text-primary mb-3"><i class="fas fa-cube"></i> E-MUTASI</h3>
            <p class="text-muted mb-4">Sistem Manajemen Kepegawaian</p>
            <form @submit.prevent="login">
                <div class="form-floating mb-3">
                    <input v-model="formLogin.url" class="form-control" placeholder="URL" required>
                    <label>URL Web App</label>
                </div>
                <div class="form-floating mb-3">
                    <input v-model="formLogin.token" type="password" class="form-control" placeholder="Token" required>
                    <label>Token API</label>
                </div>
                <button class="btn btn-primary w-100 py-2" :disabled="loading">
                    <span v-if="loading" class="spinner-border spinner-border-sm"></span>
                    <span v-else>MASUK APLIKASI</span>
                </button>
            </form>
        </div>
    </div>

    <div v-else>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm mb-4">
            <div class="container-fluid px-4">
                <a class="navbar-brand fw-bold" href="#"><i class="fas fa-cube"></i> E-MUTASI</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="nav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item" v-for="m in menus" :key="m.id">
                            <a class="nav-link" :class="{active: currentView===m.id}" href="#" @click.prevent="currentView=m.id"><i :class="m.icon"></i> {{m.label}}</a>
                        </li>
                    </ul>
                    <button class="btn btn-danger btn-sm" @click="logout"><i class="fas fa-power-off"></i> Keluar</button>
                </div>
            </div>
        </nav>

        <div class="container-fluid px-4 pb-5">
            <transition name="fade" mode="out-in">
                
                <div v-if="currentView === 'dashboard'" key="dash">
                    <div class="row mb-4">
                        <div class="col-md-6"><div class="card bg-success text-white"><div class="card-body"><h2>{{ stats.terisi }}</h2><small>Jabatan Terisi</small></div></div></div>
                        <div class="col-md-6"><div class="card bg-danger text-white"><div class="card-body"><h2>{{ stats.kosong }}</h2><small>Jabatan Kosong</small></div></div></div>
                    </div>
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold">Peta Jabatan Organisasi</div>
                        <div class="card-body">
                            <data-table :headers="['Jabatan', 'Eselon', 'Status', 'Pemegang']" :items="dashboardData">
                                <template #row="{ item }">
                                    <td>{{ item.nama_jabatan }}</td><td>{{ item.eselon }}</td>
                                    <td><span :class="['status-badge', item.status === 'TERISI' ? 'bg-terisi' : 'bg-kosong']">{{ item.status }}</span></td>
                                    <td><div v-if="item.status === 'TERISI'"><b>{{ item.pemegang.nama }}</b><br><small class="text-muted">{{ item.pemegang.nip }}</small></div><span v-else class="text-muted">-</span></td>
                                </template>
                            </data-table>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'pejabat'" key="pejabat">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center"><span>Data Pejabat</span><button class="btn btn-primary btn-sm" @click="modalPejabat()"><i class="fas fa-plus"></i> Tambah</button></div>
                        <div class="card-body">
                            <data-table-server :headers="['NIP', 'Nama', 'Pangkat', 'Aksi']" :items="pejabatData" :total-items="pejabatTotal" :loading="pejabatLoading" @request-data="fetchPejabat">
                                <template #row="{ item }">
                                    <td>{{ item.nip }}</td><td>{{ item.nama }}</td><td>{{ formatPangkat(item.pangkat) }}</td>
                                    <td><button class="btn btn-warning btn-sm me-1" @click="modalPejabat(item)"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" @click="hapusPejabat(item.nip)"><i class="fas fa-trash"></i></button></td>
                                </template>
                            </data-table-server>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'formasi'" key="formasi">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between"><span>Master Formasi</span><button class="btn btn-primary btn-sm" @click="modalFormasi()"><i class="fas fa-plus"></i> Tambah</button></div>
                        <div class="card-body">
                            <data-table :headers="['Jabatan', 'Eselon', 'Unit Kerja', 'Jenis', 'Aksi']" :items="formasiData">
                                <template #row="{ item }">
                                    <td>{{ item.nama_jabatan }}</td><td>{{ item.eselon }}</td><td>{{ item.unit_kerja || '-' }}</td><td><span class="badge bg-info text-dark">{{ item.jenis_jabatan }}</span></td>
                                    <td><button class="btn btn-warning btn-sm me-1" @click="modalFormasi(item)"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" @click="hapusFormasi(item.id)"><i class="fas fa-trash"></i></button></td>
                                </template>
                            </data-table>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'mutasi'" key="mutasi">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-primary text-white fw-bold">FORMULIR MUTASI</div>
                                <div class="card-body">
                                    <form @submit.prevent="submitMutasi">
                                        <div class="mb-3">
                                            <label class="small fw-bold">Pegawai</label>
                                            <select2-server v-model="mutasiForm.nip" :api-url="activeUrl" :token="activeToken" placeholder="Cari Pegawai..."></select2-server>
                                        </div>
                                        <div class="mb-3">
                                            <label class="small fw-bold text-danger">Jenis Mutasi</label>
                                            <select v-model="mutasiForm.jenis_mutasi" class="form-select">
                                                <option value="Promosi">Promosi</option><option value="Rotasi">Rotasi</option><option value="Demosi">Demosi / Non-Job</option><option value="Mutasi Masuk">Mutasi Masuk</option>
                                            </select>
                                            <div v-if="isDemosi" class="small text-danger mt-1"><i class="fas fa-exclamation-triangle"></i> Jabatan lama ditutup, masuk Non-Job.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="small fw-bold">Jabatan Tujuan <span class="badge bg-success" v-if="!isDemosi">Hanya Kosong</span></label>
                                            <select2 v-model="mutasiForm.id_formasi" :options="emptyFormasiOptions" :disabled="isDemosi" placeholder="Cari Jabatan Kosong..."></select2>
                                        </div>
                                        <div class="mb-3"><label class="small fw-bold text-success">Keterangan / No SK</label><textarea v-model="mutasiForm.keterangan" class="form-control" rows="3" placeholder="Detail..."></textarea></div>
                                        <div class="mb-3"><label class="small fw-bold text-primary">Link Dokumen</label><input v-model="mutasiForm.dokumen_pendukung" class="form-control" placeholder="https://..."></div>
                                        <button class="btn btn-success w-100 fw-bold">SIMPAN MUTASI</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header bg-white fw-bold">Cek Riwayat</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="small fw-bold">Cari Pegawai:</label>
                                        <select2-server v-model="searchNip" :api-url="activeUrl" :token="activeToken" placeholder="Ketik Nama..."></select2-server>
                                    </div>
                                    <button class="btn btn-secondary w-100 mb-3" @click="cariRiwayat"><i class="fas fa-search"></i> Tampilkan</button>
                                    <ul v-if="riwayatList.length" class="list-group list-group-flush">
                                        <li v-for="h in riwayatList" class="list-group-item px-0">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <div class="fw-bold text-primary">{{ h.jabatan_nama }}</div>
                                                    <div class="small text-muted">{{ h.unit_kerja }} | Eselon: {{ h.eselon }}</div>
                                                    <div class="small text-muted fst-italic">{{ h.jenis }} - {{ h.ket }}</div>
                                                    <div class="small text-muted" style="font-size:0.7rem">{{ h.tanggal ? new Date(h.tanggal).toLocaleDateString() : '-' }}</div>
                                                </div>
                                                <span :class="['badge', h.status==='AKTIF'?'bg-success':'bg-secondary']">{{h.status}}</span>
                                            </div>
                                        </li>
                                    </ul>
                                    <div v-else-if="searched" class="alert alert-warning small py-2">Tidak ada data.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'laporan'" key="laporan">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="m-0 fw-bold text-primary"><i class="fas fa-file-alt"></i> Laporan Mutasi</h5>
                        </div>
                        <div class="card-body border-bottom bg-light">
                            <form @submit.prevent="applyFilter" class="row g-2 align-items-end">
                                <div class="col-md-3"><label class="small fw-bold">Periode Tanggal</label><flatpickr v-model="filterLaporan.dateRange" :config="{mode:'range'}" class="form-control form-control-sm" placeholder="Pilih Rentang..."></flatpickr></div>
                                <div class="col-md-3">
                                    <label class="small fw-bold">Pegawai</label>
                                    <select2-server v-model="filterLaporan.nip" :api-url="activeUrl" :token="activeToken" placeholder="Semua Pegawai"></select2-server>
                                </div>
                                <div class="col-md-2"><label class="small fw-bold">Eselon</label><select v-model="filterLaporan.eselon" class="form-select form-select-sm"><option value="">- Semua -</option><option value="II.a">II.a</option><option value="II.b">II.b</option><option value="III.a">III.a</option><option value="III.b">III.b</option><option value="IV.a">IV.a</option><option value="IV.b">IV.b</option></select></div>
                                <div class="col-md-2"><label class="small fw-bold">Jenis</label><select v-model="filterLaporan.jenis_mutasi" class="form-select form-select-sm"><option value="">- Semua -</option><option value="Promosi">Promosi</option><option value="Rotasi">Rotasi</option><option value="Demosi">Demosi</option><option value="Mutasi Masuk">Mutasi Masuk</option></select></div>
                                <div class="col-md-2 d-flex gap-1"><button type="submit" class="btn btn-primary btn-sm w-100"><i class="fas fa-filter"></i></button><button type="button" class="btn btn-success btn-sm" @click="exportExcel" title="Export Excel"><i class="fas fa-file-excel"></i></button></div>
                            </form>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="tableExport" class="table table-bordered table-hover w-100 m-0 small table-laporan">
                                    <thead class="table-light"><tr><th width="3%">No</th><th width="20%">Nama / NIP</th><th width="8%">Pangkat</th><th width="20%">Jabatan Lama</th><th width="5%">Eselon</th><th width="20%">Jabatan Baru</th><th width="5%">Eselon</th><th width="15%">Keterangan</th><th width="5%">Dok</th></tr></thead>
                                    <tbody>
                                        <tr v-if="laporanLoading"><td colspan="9" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                                        <tr v-else-if="laporanData.length === 0"><td colspan="9" class="text-center py-4 text-muted">Tidak ada data sesuai filter.</td></tr>
                                        <tr v-else v-for="item in laporanData" :key="item.no">
                                            <td class="text-center">{{ item.no }}</td>
                                            <td class="pre-wrap fw-bold">{{ item.nama_nip }}</td>
                                            <td class="text-center">{{ formatPangkat(item.pangkat) }}</td>
                                            <td class="pre-wrap text-muted">{{ item.jabatan_lama }}</td>
                                            <td class="text-center text-muted">{{ item.eselon_lama }}</td>
                                            <td class="pre-wrap">{{ item.jabatan_baru }}</td>
                                            <td class="text-center">{{ item.eselon_baru }}</td>
                                            <td class="pre-wrap">{{ item.keterangan }}<br><span class="text-muted" style="font-size:0.7em">{{ item.tanggal ? new Date(item.tanggal).toLocaleDateString() : '' }}</span></td>
                                            <td class="text-center"><a v-if="item.dokumen && item.dokumen.length > 5" :href="item.dokumen" target="_blank" class="btn btn-sm btn-outline-primary py-0"><i class="fas fa-link"></i></a><span v-else>-</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'nonjob'" key="nonjob">
                     <div class="card shadow-sm border-warning">
                        <div class="card-header bg-warning text-dark fw-bold">Laporan Non-Job</div>
                        <div class="card-body">
                            <data-table :headers="['NIP', 'Nama', 'Pangkat', 'Status']" :items="nonJobData">
                                <template #row="{ item }"><td>{{ item.nip }}</td><td>{{ item.nama }}</td><td>{{ item.pangkat }}</td><td><span class="badge bg-warning text-dark">Non-Job</span></td></template>
                            </data-table>
                        </div>
                    </div>
                </div>

            </transition>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script type="module">
    import { createApp, ref, reactive, computed, watch, onMounted } from 'vue';
    import { createPinia, storeToRefs } from 'pinia';
    import { auth, api } from './api.js';
    import { useMainStore } from './store.js';
    import Swal from 'sweetalert2';

    // COMPONENTS
    const Select2 = { props: ['modelValue', 'options', 'disabled', 'placeholder'], template: `<select class="form-select" :disabled="disabled"></select>`, mounted() { const vm = this; $(this.$el).select2({ theme: 'bootstrap-5', width: '100%', placeholder: this.placeholder, data: this.options }).val(this.modelValue).trigger('change').on('change', function() { vm.$emit('update:modelValue', $(this).val()); }); }, watch: { modelValue(val) { $(this.$el).val(val).trigger('change'); }, options(opts) { $(this.$el).empty().select2({ theme: 'bootstrap-5', width: '100%', placeholder: this.placeholder, data: opts }).val(this.modelValue).trigger('change'); }, disabled(val) { $(this.$el).prop('disabled', val); } } };
    
    // FIXED SELECT2 SERVER: Uses function for URL to be reactive
    const Select2Server = { props: ['modelValue', 'apiUrl', 'token', 'placeholder'], template: `<select class="form-select"></select>`, mounted() { const vm = this; $(this.$el).select2({ theme: 'bootstrap-5', width: '100%', placeholder: this.placeholder, allowClear: true, ajax: { url: function(){return vm.apiUrl}, dataType: 'json', delay: 500, data: (params) => ({ action: 'get_pejabat', token: vm.token, q: params.term||'', page: params.page||1, limit: 10 }), processResults: (data) => ({ results: data.data.items, pagination: { more: (data.data.pagination.page * 10) < data.data.pagination.total_items } }) } }).on('change', function() { vm.$emit('update:modelValue', $(this).val()); }); } };
    
    const FlatpickrComp = { props: ['modelValue', 'placeholder', 'config'], template: `<input type="text" :placeholder="placeholder">`, mounted() { flatpickr(this.$el, { dateFormat: "Y-m-d", allowInput: true, ...this.config, onChange: (d, s) => this.$emit('update:modelValue', s) }); } };
    const DataTable = { props: ['headers', 'items'], data: () => ({ search: '', pageSize: 10, currentPage: 1 }), computed: { filtered() { if(!this.search) return this.items; const l = this.search.toLowerCase(); return this.items.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(l))); }, paged() { const s = (this.currentPage - 1) * this.pageSize; return this.filtered.slice(s, s + this.pageSize); }, pages() { return Math.ceil(this.filtered.length / this.pageSize); } }, template: `<div><div class="d-flex justify-content-between mb-3"><select v-model="pageSize" class="form-select w-auto"><option :value="5">5</option><option :value="10">10</option></select><input v-model="search" class="form-control w-auto" placeholder="Cari..."></div><div class="table-responsive"><table class="table table-hover table-striped"><thead class="table-light"><tr><th v-for="h in headers">{{h}}</th></tr></thead><tbody><tr v-for="i in paged"><slot name="row" :item="i"></slot></tr></tbody></table></div><div class="d-flex justify-content-between mt-2" v-if="pages>1"><small>Hal {{currentPage}}/{{pages}}</small><div><button class="btn btn-sm btn-outline-secondary me-1" :disabled="currentPage===1" @click="currentPage--">Prev</button><button class="btn btn-sm btn-outline-secondary" :disabled="currentPage===pages" @click="currentPage++">Next</button></div></div></div>` };
    const DataTableServer = { props: ['headers', 'items', 'totalItems', 'loading'], data: () => ({ search: '', pageSize: 10, currentPage: 1, timer: null }), watch: { search() { clearTimeout(this.timer); this.timer = setTimeout(() => { this.currentPage=1; this.emit(); }, 500); }, currentPage() { this.emit(); } }, methods: { emit() { this.$emit('request-data', { page: this.currentPage, limit: this.pageSize, search: this.search }); } }, template: `<div><div class="d-flex justify-content-between mb-3"><select v-model="pageSize" class="form-select w-auto" disabled><option :value="10">10</option></select><input v-model="search" class="form-control w-auto" placeholder="Cari (Server)..."></div><div class="table-responsive position-relative"><div v-if="loading" class="position-absolute top-50 start-50 translate-middle bg-white p-2 border shadow"><div class="spinner-border spinner-border-sm"></div></div><table class="table table-hover table-striped" :class="{'opacity-50':loading}"><thead class="table-light"><tr><th v-for="h in headers">{{h}}</th></tr></thead><tbody><tr v-for="i in items"><slot name="row" :item="i"></slot></tr></tbody></table></div><div class="d-flex justify-content-between mt-2"><small>Total {{totalItems}}</small><div><button class="btn btn-sm btn-outline-secondary me-1" :disabled="currentPage===1||loading" @click="currentPage--">Prev</button><button class="btn btn-sm btn-outline-secondary" :disabled="(currentPage*pageSize)>=totalItems||loading" @click="currentPage++">Next</button></div></div></div>` };

    const app = createApp({
        components: { 'select2': Select2, 'select2-server': Select2Server, 'flatpickr': FlatpickrComp, 'data-table': DataTable, 'data-table-server': DataTableServer },
        setup() {

            const REF_PANGKAT = {
                // GOLONGAN I (JURU)
                "I/a": "Juru Muda",
                "I/b": "Juru Muda Tk. I",
                "I/c": "Juru",
                "I/d": "Juru Tk. I",
                // GOLONGAN II (PENGATUR)
                "II/a": "Pengatur Muda",
                "II/b": "Pengatur Muda Tk. I",
                "II/c": "Pengatur",
                "II/d": "Pengatur Tk. I",
                // GOLONGAN III (PENATA)
                "III/a": "Penata Muda",
                "III/b": "Penata Muda Tk. I",
                "III/c": "Penata",
                "III/d": "Penata Tk. I",
                // GOLONGAN IV (PEMBINA)
                "IV/a": "Pembina",
                "IV/b": "Pembina Tk. I",
                "IV/c": "Pembina Utama Muda",
                "IV/d": "Pembina Utama Madya",
                "IV/e": "Pembina Utama"
            };
            const isLoggedIn = ref(auth.isLoggedIn());
            const formLogin = reactive({ url: auth.getUrl() || '', token: auth.getToken() || '' });
            
            // REACTIVE STATE FOR SELECT2
            const activeUrl = ref(auth.getUrl() || ''); 
            const activeToken = ref(auth.getToken() || '');

            const loading = ref(false);
            const currentView = ref('dashboard');
            const menus = [{id:'dashboard',label:'Dashboard',icon:'fas fa-chart-pie'},{id:'pejabat',label:'Data Pejabat',icon:'fas fa-users'},{id:'formasi',label:'Master Formasi',icon:'fas fa-sitemap'},{id:'mutasi',label:'Proses Mutasi',icon:'fas fa-exchange-alt'},{id:'nonjob',label:'Laporan Non-Job',icon:'fas fa-user-clock'},{id:'laporan',label:'Laporan Mutasi',icon:'fas fa-file-excel'}];
            
            const store = useMainStore();
            const { formasiList } = storeToRefs(store);

            const dashboardData = ref([]);
            const pejabatData = ref([]); const pejabatTotal = ref(0); const pejabatLoading = ref(false);
            const nonJobData = ref([]);
            
            const laporanData = ref([]); const laporanLoading = ref(false);
            const filterLaporan = reactive({ dateRange: '', nip: '', eselon: '', jenis_mutasi: '' });

            const mutasiForm = reactive({ nip: '', id_formasi: '', jenis_mutasi: 'Rotasi', keterangan: '', dokumen_pendukung: '' });
            const isDemosi = computed(() => mutasiForm.jenis_mutasi === 'Demosi');
            const emptyFormasiOptions = computed(() => store.emptyFormasiList.map(f => ({ id: f.id, text: `[${f.eselon}] ${f.nama_jabatan} - ${f.unit_kerja||''}` })));
            const searchNip = ref(''); const riwayatList = ref([]); const searched = ref(false);
            const stats = computed(() => ({ terisi: dashboardData.value.filter(x=>x.status==='TERISI').length, kosong: dashboardData.value.filter(x=>x.status==='KOSONG').length }));
            const formatPangkat = (kode) => {
                if (!kode) return '-';
                const cleanKode = kode.trim();
                // Jika kodenya ditemukan di kamus (misal "IV/b"), return format lengkap
                if (REF_PANGKAT[cleanKode]) {
                    return `${REF_PANGKAT[cleanKode]} (${cleanKode})`;
                }
                // Jika tidak ketemu (mungkin sudah format lengkap), kembalikan aslinya
                return cleanKode;
            };
            const login = async () => { 
                loading.value = true; 
                try { 
                    await auth.login(formLogin.url, formLogin.token); 
                    isLoggedIn.value = true; 
                    activeUrl.value = formLogin.url; activeToken.value = formLogin.token; // Update Reactive Refs
                    loadData('dashboard'); 
                } catch(e) { Swal.fire('Gagal', e.message, 'error'); } finally { loading.value = false; } 
            };
            const logout = () => auth.logout();

            const loadData = async (view) => {
                Swal.showLoading();
                try {
                    if(view==='dashboard') { const res = await api.getDashboard(); dashboardData.value = res.data; await store.fetchDashboard(true); }
                    else if(view==='pejabat') { fetchPejabat({page:1,limit:10,search:''}); }
                    else if(view==='formasi') { await store.fetchFormasi(); }
                    else if(view==='nonjob') { const res = await api.getNonJob(); nonJobData.value = res.data; }
                    else if(view==='mutasi') { await Promise.all([store.fetchFormasi(), store.fetchDashboard(true)]); } 
                    Swal.close();
                } catch(e) { Swal.fire('Error', 'Gagal memuat data', 'error'); }
            };

            const applyFilter = async () => {
                laporanLoading.value = true;
                try {
                    let start='', end=''; if(filterLaporan.dateRange.includes(' to ')) [start,end] = filterLaporan.dateRange.split(' to '); else start=filterLaporan.dateRange;
                    const payload = { start_date: start, end_date: end, nip: filterLaporan.nip, eselon: filterLaporan.eselon, jenis_mutasi: filterLaporan.jenis_mutasi };
                    const res = await api.getLaporanMutasi(payload);
                    laporanData.value = res.data;
                } catch(e) { Swal.fire('Error', 'Gagal filter laporan', 'error'); } finally { laporanLoading.value = false; }
            };
            // --- FUNGSI EXPORT EXCEL (ADVANCED STYLING) ---
            const exportExcel = () => {
                if (laporanData.value.length === 0) {
                    Swal.fire('Info', 'Tidak ada data untuk diexport', 'info');
                    return;
                }

                // 1. DEFINISI HEADER & KOLOM
                const headers = [
                    "NO", "NAMA/NIP", "PANGKAT/GOL", 
                    "JABATAN LAMA", "ESELON\nLAMA", 
                    "JABATAN BARU", "ESELON\nBARU", 
                    "KETERANGAN", "DOKUMEN PENDUKUNG"
                ];
                
                // Baris Angka (Standar Naskah Dinas)
                const subHeaders = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];

                // 2. MAPPING DATA
                const dataRows = laporanData.value.map(item => [
                    item.no,
                    item.nama_nip, // Pastikan formatnya "Nama\nNIP"
                    app.formatPangkat ? app.formatPangkat(item.pangkat) : item.pangkat, // Gunakan helper format jika ada
                    item.jabatan_lama,
                    item.eselon_lama,
                    item.jabatan_baru,
                    item.eselon_baru,
                    item.keterangan,
                    item.dokumen
                ]);

                // Gabungkan Semua: Header + Angka + Data
                const wsData = [headers, subHeaders, ...dataRows];

                // 3. BUAT WORKSHEET
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // 4. DEFINISI STYLE (BORDER, COLOR, FONT)
                const borderStyle = {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                };

                const headerStyle = {
                    font: { bold: true, name: "Arial", sz: 10 },
                    fill: { fgColor: { rgb: "BFBFBF" } }, // ABU-ABU (Sesuai Gambar)
                    alignment: { horizontal: "center", vertical: "center", wrapText: true },
                    border: borderStyle
                };

                const dataStyle = {
                    font: { name: "Arial", sz: 10 },
                    alignment: { vertical: "top", wrapText: true }, // Rata Atas & Wrap
                    border: borderStyle
                };
                
                const centerStyle = { ...dataStyle, alignment: { ...dataStyle.alignment, horizontal: "center" } };

                // 5. APPLY STYLE KE SETIAP SEL
                // Range Worksheet (misal A1:I100)
                const range = XLSX.utils.decode_range(ws['!ref']);

                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cellAddress]) continue;

                        // Logic Styling:
                        if (R === 0 || R === 1) {
                            // Baris 0 & 1 adalah Header & Angka -> Pakai Style Header (Abu-abu)
                            ws[cellAddress].s = headerStyle;
                        } else {
                            // Baris Data
                            // Kolom No (0), Pangkat (2), Eselon (4,6) -> Center
                            if ([0, 2, 4, 6].includes(C)) {
                                ws[cellAddress].s = centerStyle;
                            } else {
                                ws[cellAddress].s = dataStyle;
                            }
                        }
                    }
                }

                // 6. ATUR LEBAR KOLOM (WIDTH)
                ws['!cols'] = [
                    { wch: 5 },  // No
                    { wch: 30 }, // Nama/NIP
                    { wch: 15 }, // Pangkat
                    { wch: 35 }, // Jabatan Lama
                    { wch: 8 },  // Eselon Lama
                    { wch: 35 }, // Jabatan Baru
                    { wch: 8 },  // Eselon Baru
                    { wch: 25 }, // Keterangan
                    { wch: 15 }  // Dokumen
                ];

                // 7. DOWNLOAD FILE
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Laporan Mutasi");
                XLSX.writeFile(wb, "Laporan_Mutasi_Format_SK.xlsx");
            };

            const fetchPejabat = async (p) => { pejabatLoading.value = true; try { const res = await api.getPejabat(p.page, p.limit, p.search); pejabatData.value = res.data.items; pejabatTotal.value = res.data.pagination.total_items; } catch(e){} finally { pejabatLoading.value = false; } };
            const modalPejabat = async (item=null) => { const { value: f } = await Swal.fire({ title: item?'Edit':'Tambah', html: `<input id="n" class="swal2-input" placeholder="NIP" value="${item?.nip||''}" ${item?'disabled':''}><input id="nm" class="swal2-input" placeholder="Nama" value="${item?.nama||''}"><input id="p" class="swal2-input" placeholder="Pangkat" value="${item?.pangkat||''}">`, preConfirm: () => ({ nip: $('#n').val(), nama: $('#nm').val(), pangkat: $('#p').val(), nip_lama: item?.nip }) }); if(f) { if(item) f.nip_baru = f.nip; const res = await api[item?'editPejabat':'tambahPejabat'](f); if(res.status==='success') { Swal.fire('Sukses','','success'); fetchPejabat({page:1,limit:10,search:''}); } } };
            const hapusPejabat = async (nip) => { if((await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true})).isConfirmed) { await api.hapusPejabat(nip); Swal.fire('Terhapus','','success'); fetchPejabat({page:1,limit:10,search:''}); } };
            const modalFormasi = async (item=null) => { const { value: f } = await Swal.fire({ title: item?'Edit':'Tambah', html: `<input id="nm" class="swal2-input" placeholder="Jabatan" value="${item?.nama_jabatan||''}"><input id="es" class="swal2-input" placeholder="Eselon" value="${item?.eselon||''}"><input id="uk" class="swal2-input" placeholder="Unit" value="${item?.unit_kerja||''}"><select id="jn" class="swal2-input"><option>Administrator</option><option>Pengawas</option><option>JPT</option><option>Pelaksana</option><option>Fungsional</option></select>`, didOpen:()=>{ if(item) $('#jn').val(item.jenis_jabatan); }, preConfirm: () => ({ id: item?.id, nama_jabatan: $('#nm').val(), eselon: $('#es').val(), unit_kerja: $('#uk').val(), jenis_jabatan: $('#jn').val() }) }); if(f) { const res = await api[item?'editFormasi':'tambahFormasi'](f); if(res.status==='success') { Swal.fire('Sukses','','success'); store.fetchFormasi(true); } } };
            const hapusFormasi = async (id) => { if((await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true})).isConfirmed) { await api.hapusFormasi(id); Swal.fire('Terhapus','','success'); store.fetchFormasi(true); } };
            const submitMutasi = async () => {
                // 1. Validasi Input
                if(!mutasiForm.nip) return Swal.fire('Error','Pilih Pegawai','warning');
                if(!isDemosi.value && !mutasiForm.id_formasi) return Swal.fire('Error','Pilih Jabatan','warning');
                
                // 2. Siapkan Payload
                const payload = { ...mutasiForm, id_formasi: isDemosi.value ? 0 : mutasiForm.id_formasi };
                
                Swal.showLoading();
                
                // 3. Kirim ke Server
                try {
                    const res = await api.prosesMutasi(payload);
                    
                    if(res.status==='success') { 
                        Swal.fire({icon:'success', title:'Berhasil', text: res.message, timer:1500, showConfirmButton:false}); 
                        
                        // --- PERBAIKAN DISINI ---
                        
                        // A. Reset Form ke Kosong
                        Object.assign(mutasiForm, { 
                            nip: '', 
                            id_formasi: '', 
                            jenis_mutasi: 'Rotasi', 
                            keterangan: '', 
                            dokumen_pendukung: '' 
                        }); 
                        
                        // B. Reset Cache Waktu di Store
                        store.invalidateCache(); 

                        // C. PAKSA AMBIL DATA TERBARU (PENTING!)
                        // Kita fetch ulang Dashboard agar sistem tahu mana kursi yang BARU SAJA TERISI/KOSONG
                        await Promise.all([
                            store.fetchFormasi(true),   // Refresh Master Formasi (jika ada perubahan)
                            store.fetchDashboard(true)  // Refresh Status Terisi/Kosong (Kunci agar dropdown update)
                        ]);
                        
                        // ------------------------

                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Terjadi kesalahan koneksi', 'error');
                }
            };
            const cariRiwayat = async () => { if(!searchNip.value) return; riwayatList.value = []; await store.fetchFormasi(); const res = await api.getRiwayat(searchNip.value); riwayatList.value = res.data.map(h => { const f = store.getFormasiDetail(h.jabatan_id); return { ...h, jabatan_nama: f ? f.nama_jabatan : `ID ${h.jabatan_id} (Arsip/NonJob)`, unit_kerja: f?.unit_kerja||'-', eselon: f?.eselon||'-' }; }); searched.value = true; };

            watch(currentView, loadData);
            onMounted(() => { if(isLoggedIn.value) loadData('dashboard'); });

            return { formatPangkat, isLoggedIn, formLogin, loading, login, logout, currentView, menus, dashboardData, stats, pejabatData, pejabatTotal, pejabatLoading, modalPejabat, hapusPejabat, fetchPejabat, formasiData: formasiList, modalFormasi, hapusFormasi, nonJobData, mutasiForm, isDemosi, emptyFormasiOptions, submitMutasi, searchNip, riwayatList, searched, cariRiwayat, auth, laporanData, laporanLoading, filterLaporan, applyFilter, exportExcel, activeUrl, activeToken };
        }
    });

    app.use(createPinia());
    app.mount('#app');
</script>
</body>
</html>
